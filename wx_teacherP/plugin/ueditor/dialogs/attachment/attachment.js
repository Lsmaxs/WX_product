!function(){var uploadFile,onlineFile;window.onload=function(){initTabs(),initButtons()};function initTabs(){for(var a=$G("tabhead").children,b=0;b<a.length;b++)domUtils.on(a[b],"click",function(a){var b=a.target||a.srcElement;setTabFocus(b.getAttribute("data-content-id"))});setTabFocus("upload")}function setTabFocus(a){if(a){var b,c,d=$G("tabhead").children;for(b=0;b<d.length;b++)c=d[b].getAttribute("data-content-id"),c==a?(domUtils.addClass(d[b],"focus"),domUtils.addClass($G(c),"focus")):(domUtils.removeClasses(d[b],"focus"),domUtils.removeClasses($G(c),"focus"));switch(a){case"upload":uploadFile=uploadFile||new UploadFile("queueList");break;case"online":onlineFile=onlineFile||new OnlineFile("fileList")}}}function initButtons(){dialog.onok=function(){for(var a,b=[],c=$G("tabhead").children,d=0;d<c.length;d++)if(domUtils.hasClass(c[d],"focus")){a=c[d].getAttribute("data-content-id");break}switch(a){case"upload":b=uploadFile.getInsertList();var e=uploadFile.getQueueCount();if(e)return $(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,e)+"</span>"),!1;break;case"online":b=onlineFile.getInsertList()}editor.execCommand("insertfile",b)}}function UploadFile(a){this.$wrap=a.constructor==String?$("#"+a):$(a),this.init()}UploadFile.prototype={init:function(){this.fileList=[],this.initContainer(),this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){var a,b=this,c=jQuery,d=b.$wrap,e=d.find(".filelist"),f=d.find(".statusBar"),g=f.find(".info"),h=d.find(".uploadBtn"),i=(d.find(".filePickerBtn"),d.find(".filePickerBlock")),j=d.find(".placeholder"),k=f.find(".progress").hide(),l=0,m=0,n=window.devicePixelRatio||1,o=113*n,p=113*n,q="",r={},s=function(){var a=document.createElement("p").style,b="transition"in a||"WebkitTransition"in a||"MozTransition"in a||"msTransition"in a||"OTransition"in a;return a=null,b}(),t=editor.getActionUrl(editor.getOpt("fileActionName")),u=editor.getOpt("fileMaxSize"),v=(editor.getOpt("fileAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");if(!WebUploader.Uploader.support())return void c("#filePickerReady").after(c("<div>").html(lang.errorNotSupport)).hide();if(!editor.getOpt("fileActionName"))return void c("#filePickerReady").after(c("<div>").html(lang.errorLoadConfig)).hide();a=b.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:t,fileVal:editor.getOpt("fileFieldName"),duplicate:!0,fileSingleSizeLimit:u,compress:!1}),a.addButton({id:"#filePickerBlock"}),a.addButton({id:"#filePickerBtn",label:lang.uploadAddFile}),z("pedding");function w(b){var d=c('<li id="'+b.id+'"><p class="title">'+b.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),e=c('<div class="file-panel"><span class="cancel">'+lang.uploadDelete+'</span><span class="rotateRight">'+lang.uploadTurnRight+'</span><span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(d),f=d.find("p.progress span"),g=d.find("p.imgWrap"),h=c('<p class="error"></p>').hide().appendTo(d),j=function(a){switch(a){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry}h.text(text).show()};"invalid"===b.getStatus()?j(b.statusText):(g.text(lang.uploadPreview),-1=="|png|jpg|jpeg|bmp|gif|".indexOf("|"+b.ext.toLowerCase()+"|")?g.empty().addClass("notimage").append('<i class="file-preview file-type-'+b.ext.toLowerCase()+'"></i><span class="file-title" title="'+b.name+'">'+b.name+"</span>"):browser.ie&&browser.version<=7?g.text(lang.uploadNoPreview):a.makeThumb(b,function(a,b){if(a||!b)g.text(lang.uploadNoPreview);else{var d=c('<img src="'+b+'">');g.empty().append(d),d.on("error",function(){g.text(lang.uploadNoPreview)})}},o,p),r[b.id]=[b.size,0],b.rotation=0,b.ext&&-1!=v.indexOf(b.ext.toLowerCase())||(j("not_allow_type"),a.removeFile(b))),b.on("statuschange",function(a,c){"progress"===c?f.hide().width(0):"queued"===c&&(d.off("mouseenter mouseleave"),e.remove()),"error"===a||"invalid"===a?(j(b.statusText),r[b.id][1]=1):"interrupt"===a?j("interrupt"):"queued"===a?r[b.id][1]=0:"progress"===a&&(h.hide(),f.css("display","block")),d.removeClass("state-"+c).addClass("state-"+a)}),d.on("mouseenter",function(){e.stop().animate({height:30})}),d.on("mouseleave",function(){e.stop().animate({height:0})}),e.on("click","span",function(){var d,e=c(this).index();switch(e){case 0:return void a.removeFile(b);case 1:b.rotation+=90;break;case 2:b.rotation-=90}s?(d="rotate("+b.rotation+"deg)",g.css({"-webkit-transform":d,"-mos-transform":d,"-o-transform":d,transform:d})):g.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(b.rotation/90%4+4)%4+")")}),d.insertBefore(i)}function x(a){var b=c("#"+a.id);delete r[a.id],y(),b.off().find(".file-panel").off().end().remove()}function y(){var a,b=0,d=0,e=k.children();c.each(r,function(a,c){d+=c[0],b+=c[0]*c[1]}),a=d?b/d:0,e.eq(0).text(Math.round(100*a)+"%"),e.eq(1).css("width",Math.round(100*a)+"%"),A()}function z(c,d){if(c!=q){var i=a.getStats();switch(h.removeClass("state-"+q),h.addClass("state-"+c),c){case"pedding":e.addClass("element-invisible"),f.addClass("element-invisible"),j.removeClass("element-invisible"),k.hide(),g.hide(),a.refresh();break;case"ready":j.addClass("element-invisible"),e.removeClass("element-invisible"),f.removeClass("element-invisible"),k.hide(),g.show(),h.text(lang.uploadStart),a.refresh();break;case"uploading":k.show(),g.hide(),h.text(lang.uploadPause);break;case"paused":k.show(),g.hide(),h.text(lang.uploadContinue);break;case"confirm":if(k.show(),g.hide(),h.text(lang.uploadStart),i=a.getStats(),i.successNum&&!i.uploadFailNum)return void z("finish");break;case"finish":k.hide(),g.show(),i.uploadFailNum?h.text(lang.uploadRetry):h.text(lang.uploadStart)}q=c,A()}b.getQueueCount()?h.removeClass("disabled"):h.addClass("disabled")}function A(){var b,c="";"ready"===q?c=lang.updateStatusReady.replace("_",l).replace("_KB",WebUploader.formatSize(m)):"confirm"===q?(b=a.getStats(),b.uploadFailNum&&(c=lang.updateStatusConfirm.replace("_",b.successNum).replace("_",b.successNum))):(b=a.getStats(),c=lang.updateStatusFinish.replace("_",l).replace("_KB",WebUploader.formatSize(m)).replace("_",b.successNum),b.uploadFailNum&&(c+=lang.updateStatusError.replace("_",b.uploadFailNum))),g.html(c)}a.on("fileQueued",function(a){l++,m+=a.size,1===l&&(j.addClass("element-invisible"),f.show()),w(a)}),a.on("fileDequeued",function(a){l--,m-=a.size,x(a),y()}),a.on("filesQueued",function(b){a.isInProgress()||"pedding"!=q&&"finish"!=q&&"confirm"!=q&&"ready"!=q||z("ready"),y()}),a.on("all",function(b,c){switch(b){case"uploadFinished":z("confirm",c);break;case"startUpload":var d=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",e=utils.formatUrl(t+(-1==t.indexOf("?")?"?":"&")+"encode=utf-8&"+d);a.option("server",e),z("uploading",c);break;case"stopUpload":z("paused",c)}}),a.on("uploadBeforeSend",function(a,b,c){c.X_Requested_With="XMLHttpRequest"}),a.on("uploadProgress",function(a,b){var d=c("#"+a.id),e=d.find(".progress span");e.css("width",100*b+"%"),r[a.id][1]=b,y()}),a.on("uploadSuccess",function(a,d){var e=c("#"+a.id);try{var f=d._raw||d,g=utils.str2json(f);"SUCCESS"==g.state?(b.fileList.push(g),e.append('<span class="success"></span>')):e.find(".error").text(g.state).show()}catch(h){e.find(".error").text(lang.errorServerUpload).show()}}),a.on("uploadError",function(a,b){}),a.on("error",function(a,b){("Q_TYPE_DENIED"==a||"F_EXCEED_SIZE"==a)&&w(b)}),a.on("uploadComplete",function(a,b){}),h.on("click",function(){return c(this).hasClass("disabled")?!1:void("ready"===q?a.upload():"paused"===q?a.upload():"uploading"===q&&a.stop())}),h.addClass("state-"+q),y()},getQueueCount:function(){var a,b,c,d=0,e=this.uploader.getFiles();for(b=0;a=e[b++];)c=a.getStatus(),("queued"==c||"uploading"==c||"progress"==c)&&d++;return d},getInsertList:function(){var a,b,c,d=[],e=editor.getOpt("fileUrlPrefix");for(a=0;a<this.fileList.length;a++)c=this.fileList[a],b=c.url,d.push({title:c.original||b.substr(b.lastIndexOf("/")+1),url:e+b});return d}};function OnlineFile(a){this.container=utils.isString(a)?document.getElementById(a):a,this.init()}OnlineFile.prototype={init:function(){this.initContainer(),this.initEvents(),this.initData()},initContainer:function(){this.container.innerHTML="",this.list=document.createElement("ul"),this.clearFloat=document.createElement("li"),domUtils.addClass(this.list,"list"),domUtils.addClass(this.clearFloat,"clearFloat"),this.list.appendChild(this.clearFloat),this.container.appendChild(this.list)},initEvents:function(){var a=this;domUtils.on($G("fileList"),"scroll",function(b){var c=this;c.scrollHeight-(c.offsetHeight+c.scrollTop)<10&&a.getFileData()}),domUtils.on(this.list,"click",function(a){var b=a.target||a.srcElement,c=b.parentNode;"li"==c.tagName.toLowerCase()&&(domUtils.hasClass(c,"selected")?domUtils.removeClasses(c,"selected"):domUtils.addClass(c,"selected"))})},initData:function(){this.state=0,this.listSize=editor.getOpt("fileManagerListSize"),this.listIndex=0,this.listEnd=!1,this.getFileData()},getFileData:function(){var _this=this;_this.listEnd||this.isLoadingData||(this.isLoadingData=!0,ajax.request(editor.getActionUrl(editor.getOpt("fileManagerActionName")),{timeout:1e5,data:utils.extend({start:this.listIndex,size:this.listSize},editor.queryCommandValue("serverparam")),method:"get",onsuccess:function(r){try{var json=eval("("+r.responseText+")");"SUCCESS"==json.state&&(_this.pushData(json.list),_this.listIndex=parseInt(json.start)+parseInt(json.list.length),_this.listIndex>=json.total&&(_this.listEnd=!0),_this.isLoadingData=!1)}catch(e){if(-1!=r.responseText.indexOf("ue_separate_ue")){var list=r.responseText.split(r.responseText);_this.pushData(list),_this.listIndex=parseInt(list.length),_this.listEnd=!0,_this.isLoadingData=!1}}},onerror:function(){_this.isLoadingData=!1}}))},pushData:function(a){var b,c,d,e,f,g=this,h=editor.getOpt("fileManagerUrlPrefix");for(b=0;b<a.length;b++)if(a[b]&&a[b].url){if(c=document.createElement("li"),f=document.createElement("span"),d=a[b].url.substr(a[b].url.lastIndexOf(".")+1),-1!="png|jpg|jpeg|gif|bmp".indexOf(d))e=document.createElement("img"),domUtils.on(e,"load",function(a){return function(){g.scale(a,a.parentNode.offsetWidth,a.parentNode.offsetHeight)}}(e)),e.width=113,e.setAttribute("src",h+a[b].url+(-1==a[b].url.indexOf("?")?"?noCache=":"&noCache=")+(+new Date).toString(36));else{var i=document.createElement("i"),j=document.createElement("span");j.innerHTML=a[b].url.substr(a[b].url.lastIndexOf("/")+1),e=document.createElement("div"),e.appendChild(i),e.appendChild(j),domUtils.addClass(e,"file-wrapper"),domUtils.addClass(j,"file-title"),domUtils.addClass(i,"file-type-"+d),domUtils.addClass(i,"file-preview")}domUtils.addClass(f,"icon"),c.setAttribute("data-url",h+a[b].url),a[b].original&&c.setAttribute("data-title",a[b].original),c.appendChild(e),c.appendChild(f),this.list.insertBefore(c,this.clearFloat)}},scale:function(a,b,c,d){var e=a.width,f=a.height;"justify"==d?e>=f?(a.width=b,a.height=c*f/e,a.style.marginLeft="-"+parseInt((a.width-b)/2)+"px"):(a.width=b*e/f,a.height=c,a.style.marginTop="-"+parseInt((a.height-c)/2)+"px"):e>=f?(a.width=b*e/f,a.height=c,a.style.marginLeft="-"+parseInt((a.width-b)/2)+"px"):(a.width=b,a.height=c*f/e,a.style.marginTop="-"+parseInt((a.height-c)/2)+"px")},getInsertList:function(){var a,b=this.list.children,c=[];for(a=0;a<b.length;a++)if(domUtils.hasClass(b[a],"selected")){var d=b[a].getAttribute("data-url"),e=b[a].getAttribute("data-title")||d.substr(d.lastIndexOf("/")+1);c.push({title:e,url:d})}return c}}}();