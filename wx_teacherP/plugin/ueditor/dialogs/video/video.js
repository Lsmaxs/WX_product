!function(){var a,b=[],c=!1;window.onload=function(){$focus($G("videoUrl")),d(),e(),s()};function d(){for(var a=$G("tabHeads").children,b=0;b<a.length;b++)domUtils.on(a[b],"click",function(b){var c,d,e=b.target||b.srcElement;for(c=0;c<a.length;c++)d=a[c].getAttribute("data-content-id"),a[c]==e?(domUtils.addClass(a[c],"focus"),domUtils.addClass($G(d),"focus")):(domUtils.removeClasses(a[c],"focus"),domUtils.removeClasses($G(d),"focus"))})}function e(){n(["videoFloat","upload_alignment"]),p($G("videoUrl")),f(),function(){var a,b=editor.selection.getRange().getClosedNode();if(b&&b.className){var d="edui-faked-video"==b.className,e=-1!=b.className.indexOf("edui-upload-video");if(d||e){$G("videoUrl").value=a=b.getAttribute("_url"),$G("videoWidth").value=b.width,$G("videoHeight").value=b.height;var f=domUtils.getComputedStyle(b,"float"),h=domUtils.getComputedStyle(b.parentNode,"text-align");g("center"===h?"center":f)}e&&(c=!0)}q(a)}()}function f(){dialog.onok=function(){$G("preview").innerHTML="";var a=j("tabHeads","tabSrc");switch(a){case"video":return h();case"videoSearch":return i("searchList");case"upload":return r()}},dialog.oncancel=function(){$G("preview").innerHTML=""}}function g(a){for(var b,c=$G("videoFloat").children,d=0;b=c[d++];)b.getAttribute("name")==a?"focus"!=b.className&&(b.className="focus"):"focus"==b.className&&(b.className="")}function h(){var a=$G("videoWidth"),b=$G("videoHeight"),d=$G("videoUrl").value,e=j("videoFloat","name");return d&&l([a,b])?void editor.execCommand("insertvideo",{url:k(d),width:a.value,height:b.value,align:e},c?"upload":null):!1}function i(a){for(var b,c=domUtils.getElementsByTagName($G(a),"img"),d=[],e=0;b=c[e++];)b.getAttribute("selected")&&d.push({url:b.getAttribute("ue_video_url"),width:420,height:280,align:"none"});editor.execCommand("insertvideo",d)}function j(a,b){for(var c,d,e=$G(a).children,f=0;d=e[f++];)if("focus"==d.className){c=d.getAttribute(b);break}return c}function k(a){return a?a=utils.trim(a).replace(/v\.youku\.com\/v_show\/id_([\w\-=]+)\.html/i,"player.youku.com/player.php/sid/$1/v.swf").replace(/(www\.)?youtube\.com\/watch\?v=([\w\-]+)/i,"www.youtube.com/v/$2").replace(/youtu.be\/(\w+)$/i,"www.youtube.com/v/$1").replace(/v\.ku6\.com\/.+\/([\w\.]+)\.html.*$/i,"player.ku6.com/refer/$1/v.swf").replace(/www\.56\.com\/u\d+\/v_([\w\-]+)\.html/i,"player.56.com/v_$1.swf").replace(/www.56.com\/w\d+\/play_album\-aid\-\d+_vid\-([^.]+)\.html/i,"player.56.com/v_$1.swf").replace(/v\.pps\.tv\/play_([\w]+)\.html.*$/i,"player.pps.tv/player/sid/$1/v.swf").replace(/www\.letv\.com\/ptv\/vplay\/([\d]+)\.html.*$/i,"i7.imgs.letv.com/player/swfPlayer.swf?id=$1&autoplay=0").replace(/www\.tudou\.com\/programs\/view\/([\w\-]+)\/?/i,"www.tudou.com/v/$1").replace(/v\.qq\.com\/cover\/[\w]+\/[\w]+\/([\w]+)\.html/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/v\.qq\.com\/.+[\?\&]vid=([^&]+).*$/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/my\.tv\.sohu\.com\/[\w]+\/[\d]+\/([\d]+)\.shtml.*$/i,"share.vrs.sohu.com/my/v.swf&id=$1"):""}function l(a){for(var b,c=0;b=a[c++];){var d=b.value;if(!m(d)&&d)return alert(lang.numError),b.value="",b.focus(),!1}return!0}function m(a){return/(0|^[1-9]\d*$)/.test(a)}function n(a){for(var b,c=0;b=a[c++];){var d=$G(b),e={none:lang["default"],left:lang.floatLeft,right:lang.floatRight,center:lang.block};for(var f in e){var g=document.createElement("div");g.setAttribute("name",f),"none"==f&&(g.className="focus"),g.style.cssText="background:url(images/"+f+"_focus.jpg);",g.setAttribute("title",e[f]),d.appendChild(g)}o(b)}}function o(a){for(var b,c=$G(a).children,d=0;b=c[d++];)domUtils.on(b,"click",function(){for(var a,b=0;a=c[b++];)a.className="",a.removeAttribute&&a.removeAttribute("class");this.className="focus"})}function p(a){browser.ie?a.onpropertychange=function(){q(this.value)}:a.addEventListener("input",function(){q(this.value)},!1)}function q(a){if(a){var b=k(a);$G("preview").innerHTML='<div class="previewMsg"><span>'+lang.urlError+'</span></div><embed class="previewVideo" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" src="'+b+'" width="420" height="280" wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" allowfullscreen="true" ></embed>'}}function r(){var c=[],d=editor.getOpt("videoUrlPrefix"),e=$G("upload_width").value||420,f=$G("upload_height").value||280,g=j("upload_alignment","name")||"none";for(var h in b){var i=b[h];c.push({url:d+i.url,width:e,height:f,align:g})}var k=a.getQueueCount();return k?($(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,k)+"</span>"),!1):void editor.execCommand("insertvideo",c,"upload")}function s(){a=new t("queueList")}function t(a){this.$wrap=a.constructor==String?$("#"+a):$(a),this.init()}t.prototype={init:function(){this.fileList=[],this.initContainer(),this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){var a,c=this,d=jQuery,e=c.$wrap,f=e.find(".filelist"),g=e.find(".statusBar"),h=g.find(".info"),i=e.find(".uploadBtn"),j=(e.find(".filePickerBtn"),e.find(".filePickerBlock")),k=e.find(".placeholder"),l=g.find(".progress").hide(),m=0,n=0,o=window.devicePixelRatio||1,p=113*o,q=113*o,r="",s={},t=function(){var a=document.createElement("p").style,b="transition"in a||"WebkitTransition"in a||"MozTransition"in a||"msTransition"in a||"OTransition"in a;return a=null,b}(),u=editor.getActionUrl(editor.getOpt("videoActionName")),v=editor.getOpt("videoMaxSize"),w=(editor.getOpt("videoAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");if(!WebUploader.Uploader.support())return void d("#filePickerReady").after(d("<div>").html(lang.errorNotSupport)).hide();if(!editor.getOpt("videoActionName"))return void d("#filePickerReady").after(d("<div>").html(lang.errorLoadConfig)).hide();a=c.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:u,fileVal:editor.getOpt("videoFieldName"),duplicate:!0,fileSingleSizeLimit:v,compress:!1}),a.addButton({id:"#filePickerBlock"}),a.addButton({id:"#filePickerBtn",label:lang.uploadAddFile}),A("pedding");function x(b){var c=d('<li id="'+b.id+'"><p class="title">'+b.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),e=d('<div class="file-panel"><span class="cancel">'+lang.uploadDelete+'</span><span class="rotateRight">'+lang.uploadTurnRight+'</span><span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(c),f=c.find("p.progress span"),g=c.find("p.imgWrap"),h=d('<p class="error"></p>').hide().appendTo(c),i=function(a){switch(a){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry}h.text(text).show()};"invalid"===b.getStatus()?i(b.statusText):(g.text(lang.uploadPreview),-1=="|png|jpg|jpeg|bmp|gif|".indexOf("|"+b.ext.toLowerCase()+"|")?g.empty().addClass("notimage").append('<i class="file-preview file-type-'+b.ext.toLowerCase()+'"></i><span class="file-title">'+b.name+"</span>"):browser.ie&&browser.version<=7?g.text(lang.uploadNoPreview):a.makeThumb(b,function(a,b){if(a||!b||/^data:/.test(b)&&browser.ie&&browser.version<=7)g.text(lang.uploadNoPreview);else{var c=d('<img src="'+b+'">');g.empty().append(c),c.on("error",function(){g.text(lang.uploadNoPreview)})}},p,q),s[b.id]=[b.size,0],b.rotation=0,b.ext&&-1!=w.indexOf(b.ext.toLowerCase())||(i("not_allow_type"),a.removeFile(b))),b.on("statuschange",function(a,d){"progress"===d?f.hide().width(0):"queued"===d&&(c.off("mouseenter mouseleave"),e.remove()),"error"===a||"invalid"===a?(i(b.statusText),s[b.id][1]=1):"interrupt"===a?i("interrupt"):"queued"===a?s[b.id][1]=0:"progress"===a&&(h.hide(),f.css("display","block")),c.removeClass("state-"+d).addClass("state-"+a)}),c.on("mouseenter",function(){e.stop().animate({height:30})}),c.on("mouseleave",function(){e.stop().animate({height:0})}),e.on("click","span",function(){var c,e=d(this).index();switch(e){case 0:return void a.removeFile(b);case 1:b.rotation+=90;break;case 2:b.rotation-=90}t?(c="rotate("+b.rotation+"deg)",g.css({"-webkit-transform":c,"-mos-transform":c,"-o-transform":c,transform:c})):g.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(b.rotation/90%4+4)%4+")")}),c.insertBefore(j)}function y(a){var b=d("#"+a.id);delete s[a.id],z(),b.off().find(".file-panel").off().end().remove()}function z(){var a,b=0,c=0,e=l.children();d.each(s,function(a,d){c+=d[0],b+=d[0]*d[1]}),a=c?b/c:0,e.eq(0).text(Math.round(100*a)+"%"),e.eq(1).css("width",Math.round(100*a)+"%"),B()}function A(b,d){if(b!=r){var e=a.getStats();switch(i.removeClass("state-"+r),i.addClass("state-"+b),b){case"pedding":f.addClass("element-invisible"),g.addClass("element-invisible"),k.removeClass("element-invisible"),l.hide(),h.hide(),a.refresh();break;case"ready":k.addClass("element-invisible"),f.removeClass("element-invisible"),g.removeClass("element-invisible"),l.hide(),h.show(),i.text(lang.uploadStart),a.refresh();break;case"uploading":l.show(),h.hide(),i.text(lang.uploadPause);break;case"paused":l.show(),h.hide(),i.text(lang.uploadContinue);break;case"confirm":if(l.show(),h.hide(),i.text(lang.uploadStart),e=a.getStats(),e.successNum&&!e.uploadFailNum)return void A("finish");break;case"finish":l.hide(),h.show(),e.uploadFailNum?i.text(lang.uploadRetry):i.text(lang.uploadStart)}r=b,B()}c.getQueueCount()?i.removeClass("disabled"):i.addClass("disabled")}function B(){var b,c="";"ready"===r?c=lang.updateStatusReady.replace("_",m).replace("_KB",WebUploader.formatSize(n)):"confirm"===r?(b=a.getStats(),b.uploadFailNum&&(c=lang.updateStatusConfirm.replace("_",b.successNum).replace("_",b.successNum))):(b=a.getStats(),c=lang.updateStatusFinish.replace("_",m).replace("_KB",WebUploader.formatSize(n)).replace("_",b.successNum),b.uploadFailNum&&(c+=lang.updateStatusError.replace("_",b.uploadFailNum))),h.html(c)}a.on("fileQueued",function(a){m++,n+=a.size,1===m&&(k.addClass("element-invisible"),g.show()),x(a)}),a.on("fileDequeued",function(a){m--,n-=a.size,y(a),z()}),a.on("filesQueued",function(b){a.isInProgress()||"pedding"!=r&&"finish"!=r&&"confirm"!=r&&"ready"!=r||A("ready"),z()}),a.on("all",function(b,c){switch(b){case"uploadFinished":A("confirm",c);break;case"startUpload":var d=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",e=utils.formatUrl(u+(-1==u.indexOf("?")?"?":"&")+"encode=utf-8&"+d);a.option("server",e),A("uploading",c);break;case"stopUpload":A("paused",c)}}),a.on("uploadBeforeSend",function(a,b,c){c.X_Requested_With="XMLHttpRequest"}),a.on("uploadProgress",function(a,b){var c=d("#"+a.id),e=c.find(".progress span");e.css("width",100*b+"%"),s[a.id][1]=b,z()}),a.on("uploadSuccess",function(a,c){var e=d("#"+a.id);try{var f=c._raw||c,g=utils.str2json(f);"SUCCESS"==g.state?(b.push({url:g.url,type:g.type,original:g.original}),e.append('<span class="success"></span>')):e.find(".error").text(g.state).show()}catch(h){e.find(".error").text(lang.errorServerUpload).show()}}),a.on("uploadError",function(a,b){}),a.on("error",function(a,b){("Q_TYPE_DENIED"==a||"F_EXCEED_SIZE"==a)&&x(b)}),a.on("uploadComplete",function(a,b){}),i.on("click",function(){return d(this).hasClass("disabled")?!1:void("ready"===r?a.upload():"paused"===r?a.upload():"uploading"===r&&a.stop())}),i.addClass("state-"+r),z()},getQueueCount:function(){var a,b,c,d=0,e=this.uploader.getFiles();for(b=0;a=e[b++];)c=a.getStatus(),("queued"==c||"uploading"==c||"progress"==c)&&d++;return d},refresh:function(){this.uploader.refresh()}}}();